<div class="page-container p-6">
    <div class="page-header mb-6">
        <h2 class="text-4xl font-extrabold text-gray-900 tracking-tight m-0">Training ausführen</h2>
    </div>

    @if (errorMessage()) {
    <div class="error-banner bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
        {{ errorMessage() }}
    </div>
    }

    <div class="table-container shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
        @if (loading()) {
        <div class="loading-state p-4 text-center">Laden…</div>
        } @else {
        <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="w-full bg-white">
            <!-- Name Column -->
            <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef
                    class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Name</th>
                <td mat-cell *matCellDef="let row"
                    class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ row.name }}</td>
            </ng-container>

            <!-- Profile Column -->
            <ng-container matColumnDef="profile">
                <th mat-header-cell *matHeaderCellDef
                    class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Profil</th>
                <td mat-cell *matCellDef="let row" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{
                    getProfileName(row.profile_id) }}</td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef
                    class="px-6 py-3 border-b border-gray-200 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Aktionen</th>
                <td mat-cell *matCellDef="let row" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <button mat-flat-button color="primary" (click)="executePlan(row, $event)">
                        <mat-icon>play_arrow</mat-icon>
                        Ausführen
                    </button>
                </td>
            </ng-container>

            <!-- Expanded Content Column -->
            <ng-container matColumnDef="expandedDetail">
                <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length" class="p-0">
                    <div class="example-element-detail"
                        [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                        <div class="inner-table-container p-4 w-full bg-gray-50">
                            <h4 class="mb-2 font-semibold text-gray-700">Übungen ({{ element.exercises?.length || 0 }})
                            </h4>
                            @if (element.exercises && element.exercises.length > 0) {
                            <table
                                class="inner-table w-full text-left border-collapse bg-white shadow-sm rounded-lg overflow-hidden">
                                <thead>
                                    <tr class="text-xs text-gray-500 border-b border-gray-200 bg-gray-100">
                                        <th class="py-2 pl-4">Übung</th>
                                        <th class="py-2">Sätze</th>
                                        <th class="py-2">Wiederholungen</th>
                                        <th class="py-2">Pause (Sek)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (exercise of element.exercises; track exercise) {
                                    <tr
                                        class="border-b border-gray-100 last:border-0 hover:bg-white transition-colors duration-150">
                                        <td class="py-2 pl-4">{{ exercise.training_exercise_item?.description ||
                                            'Unbekannt' }}</td>
                                        <td class="py-2">{{ exercise.sets || '-' }}</td>
                                        <td class="py-2">{{ exercise.reps || '-' }}</td>
                                        <td class="py-2">{{ exercise.break_time_seconds || '-' }}</td>
                                    </tr>
                                    }
                                </tbody>
                            </table>
                            } @else {
                            <p class="text-gray-500 italic p-4">Keine Übungen in diesem Plan.</p>
                            }
                        </div>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let element; columns: displayedColumns;"
                class="example-element-row hover:bg-gray-50 cursor-pointer transition-colors duration-150"
                [class.example-expanded-row]="expandedElement === element"
                (click)="expandedElement = expandedElement === element ? null : element">
            </tr>
            <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>

            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell no-data-cell px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center"
                    [attr.colspan]="displayedColumns.length">
                    Keine Trainingspläne vorhanden.
                </td>
            </tr>
        </table>
        }
    </div>
</div>