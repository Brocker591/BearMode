<div class="page-container p-6">
  <div class="page-header">
    <h2 class="text-4xl font-extrabold text-gray-900 tracking-tight m-0">Trainingspläne verwalten</h2>
    @if (!formState()) {
    <button mat-flat-button color="primary" class="btn-create" (click)="openCreate()">Neuer Plan</button>
    }
  </div>

  @if (errorMessage()) {
  <div class="error-banner">
    {{ errorMessage() }}
  </div>
  }

  @if (formState(); as state) {
  <div class="profile-form-card">
    <h3 class="form-title">{{ isEditMode() ? 'Plan bearbeiten' : 'Neuen Plan erstellen' }}</h3>
    <div class="form-controls">
      <mat-form-field appearance="outline" class="form-field-name">
        <mat-label>Name</mat-label>
        <input matInput [(ngModel)]="formNameValue" placeholder="Plan Name" [disabled]="formSaving()" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-name">
        <mat-label>Profil</mat-label>
        <mat-select [(ngModel)]="formProfileIdValue" [disabled]="formSaving()">
          @for (p of profiles(); track p.id) {
          <mat-option [value]="p.id">{{ p.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <div class="form-actions">
        <button mat-button (click)="cancelForm()" [disabled]="formSaving()">Abbrechen</button>
        <button mat-flat-button color="primary" (click)="saveForm()" [disabled]="formSaving()">
          {{ formSaving() ? 'Speichern…' : 'Speichern' }}
        </button>
      </div>
    </div>
  </div>
  }

  <div class="table-container">
    @if (loading()) {
    <div class="loading-state">Laden…</div>
    } @else {
    <table mat-table [dataSource]="dataSource" class="profiles-table">
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Name</th>
        <td mat-cell *matCellDef="let row" class="cell-name">{{ row.name }}</td>
      </ng-container>

      <!-- Profile Column -->
      <ng-container matColumnDef="profile">
        <th mat-header-cell *matHeaderCellDef>Profil</th>
        <td mat-cell *matCellDef="let row">{{ getProfileName(row.profile_id) }}</td>
      </ng-container>

      <!-- Exercise Count Column -->
      <ng-container matColumnDef="exerciseCount">
        <th mat-header-cell *matHeaderCellDef>Übungen</th>
        <td mat-cell *matCellDef="let row">{{ row.training_exercises?.length || 0 }}</td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="header-actions">Aktionen</th>
        <td mat-cell *matCellDef="let row" class="cell-actions">
          <button mat-button color="primary" (click)="openEdit(row)">Bearbeiten</button>
          <button mat-button color="warn" (click)="deletePlan(row)">Löschen</button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- No Data Row -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
          Keine Trainingspläne vorhanden.
        </td>
      </tr>
    </table>
    }
  </div>
</div>