<div class="page-container p-6">
  <div class="page-header">
    <h2 class="text-4xl font-extrabold text-gray-900 tracking-tight m-0">Trainingspläne verwalten</h2>

    <button mat-flat-button color="primary" class="btn-create" (click)="openCreate()">Neuer Plan</button>
  </div>

  @if (errorMessage()) {
  <div class="error-banner">
    {{ errorMessage() }}
  </div>
  }


  <div class="table-container">
    @if (loading()) {
    <div class="loading-state">Laden…</div>
    } @else {
    <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="profiles-table">
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Name</th>
        <td mat-cell *matCellDef="let row" class="cell-name">{{ row.name }}</td>
      </ng-container>

      <!-- Profile Column -->
      <ng-container matColumnDef="profile">
        <th mat-header-cell *matHeaderCellDef>Profil</th>
        <td mat-cell *matCellDef="let row">{{ getProfileName(row.profile_id) }}</td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="header-actions">Aktionen</th>
        <td mat-cell *matCellDef="let row" class="cell-actions">
          <button mat-button color="primary" (click)="openEdit(row, $event)">Bearbeiten</button>
          <button mat-button color="warn" (click)="deletePlan(row, $event)">Löschen</button>
        </td>
      </ng-container>

      <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
          <div class="example-element-detail" [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
            <div class="inner-table-container">
              <h4 class="mb-2 font-semibold text-gray-700">Übungen ({{ element.exercises?.length || 0 }})</h4>
              @if (element.exercises && element.exercises.length > 0) {
              <table class="inner-table w-full text-left border-collapse">
                <thead>
                  <tr class="text-sm text-gray-500 border-b border-gray-200">
                    <th class="py-2 pl-4">Übung</th>
                    <th class="py-2">Sätze</th>
                    <th class="py-2">Wiederholungen</th>
                    <th class="py-2">Pause (Sek)</th>
                  </tr>
                </thead>
                <tbody>
                  @for (exercise of element.exercises; track exercise) {
                  <tr class="border-b border-gray-100 last:border-0 hover:bg-gray-50">
                    <td class="py-2 pl-4">{{ exercise.training_exercise_item?.description || 'Unbekannt' }}</td>
                    <td class="py-2">{{ exercise.sets || '-' }}</td>
                    <td class="py-2">{{ exercise.reps || '-' }}</td>
                    <td class="py-2">{{ exercise.break_time_seconds || '-' }}</td>
                  </tr>
                  }
                </tbody>
              </table>
              } @else {
              <p class="text-gray-500 italic p-4">Keine Übungen in diesem Plan.</p>
              }
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let element; columns: displayedColumns;" class="example-element-row"
        [class.example-expanded-row]="expandedElement === element"
        (click)="expandedElement = expandedElement === element ? null : element">
      </tr>
      <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>

      <!-- No Data Row -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
          Keine Trainingspläne vorhanden.
        </td>
      </tr>
    </table>
    }
  </div>
</div>